/**
* NOTICE OF LICENSE
*
* This file is part of the 'Wk Warehouses Management For Prestashop 1.7' module feature.
* Developped by Khoufi Wissem (2018).
* You are not allowed to use it on several site
* You are not allowed to sell or redistribute this module
* This header must not be removed
*
*  @author    KHOUFI Wissem - K.W
*  @copyright Khoufi Wissem
*  @license   http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
*/
function initCartButton(e){$("#add-to-cart-or-refresh button.add-to-cart").on("click",function(e){var t,a,r,s,o;return e.preventDefault(),e.stopPropagation(),t=$("#product_page_product_id").val(),a=$("#product_customization_id").val(),void 0===r&&(r=getProductData()),(s=void 0!==$("#quantity_wanted")&&$("#quantity_wanted").length?parseInt($("#quantity_wanted").val()):1)<1?(fancyCloseBox(txt_invalid_qty,"danger"),!1):(o={ajax:!0,action:"assignWarehouseToProductInCart",id_product:t,id_product_attribute:r},$("#id_warehouse").length>0&&(o.id_warehouse=parseInt($("#id_warehouse").val())),$.ajax({url:process_cart_url,type:"POST",dataType:"json",data:o,success:function(e){if(void 0!==e.multiWarehousesInCart&&e.multiWarehousesInCart)fancyCloseBox(e.message,"danger");else if(void 0!==e.isMultiCarriersInCart&&e.isMultiCarriersInCart)fancyCloseBox(e.message,"danger");else if(void 0!==e.hasError&&e.hasError)fancyCloseBox(e.message,"danger");else{var o={add:1,action:"update",id_product:t,id_customization:a,qty:s,token:prestashop.static_token};r>0&&(o.id_product_attribute=r),$("#id_warehouse").length>0&&(o.id_warehouse=parseInt($("#id_warehouse").val())),$.post(prestashop.urls.pages.cart,o,null,"json").then(function(e){prestashop.emit("updateCart",{reason:{idProduct:e.id_product,idProductAttribute:e.id_product_attribute,idCustomization:e.id_customization,linkAction:"add-to-cart",cart:e.cart},resp:e})}).fail(function(e){prestashop.emit("handleError",{eventType:"addProductToCart",resp:e})})}}}),!1)})}function fancyCloseBox(e,t){var a='<p style="text-align:right; padding-bottom: 0" class="submit">';a+='<input type="button" onclick="$.fancybox.close();" value="'+txt_ok+'" class="button btn btn-danger">',a+="</p>",$.fancybox('<div class="alert alert-'+t+'">'+e+"</div>"+a)}function getProductData(){return $product_details_element=$("#product-details").length>0?$("#product-details"):$("#product-detail"),void 0===$product_details_element.attr("data-product")&&($product_details_element=$("[data-product]")),$product_details_element.length>0&&void 0!==$product_details_element.attr("data-product")?(result=$.parseJSON($product_details_element.attr("data-product")),result.id_product_attribute):(id_product_attribute=void 0,$("#module_product_combination_id").length>0?id_product_attribute=$("#module_product_combination_id").val():$("#idCombination").length>0&&(id_product_attribute=$("#idCombination").val()),id_product_attribute)}function displayWarehousesStockInfos(e){var t,a,r;if("undefined"!=typeof product_stocks_list){if(t=JSON.parse(product_stocks_list),void 0===e&&(e=getProductData()),void 0!==e&&($("#block-warehouses-stock").replaceWith(""),void 0!==(a=t[e]))){for(r in warehouse_infos='<div id="block-warehouses-stock">',warehouse_infos+='<ul><li><i class="fas fa-warehouse"></i> <b>'+warehouses_txt+"</b></li>",a)warehouse_infos+='<li class="item"><i class="fas fa-dot-circle"></i> <strong>'+a[r].name+"</strong>",display_warehouses_stock&&(qty=a[r].available_quantity>0?parseInt(a[r].available_quantity):0,warehouse_infos+='<br ><span><i class="fas fa-caret-right"></i> '+instock_txt+"</span>: ",display_icon?warehouse_infos+='<i class="fas '+(qty>0?"fa-check green":"fa-times red")+'-color"></i> ':warehouse_infos+="<strong>"+qty+"</strong> "+(qty<=1?product_txt:products_txt)),display_warehouses_locations&&a[r].location&&(warehouse_infos+='<br ><span><i class="fas fa-caret-right"></i> '+location_txt+"</span>: ",warehouse_infos+="<strong>"+a[r].location+"</strong>"),display_deliveries_times&&a[r].delivery_time&&(warehouse_infos+='<br ><span><i class="fas fa-calendar"></i> '+a[r].delivery_time+"</span>"),display_warehouses_countries&&a[r].country&&(warehouse_infos+='<br ><span><i class="fas fa-flag"></i> '+a[r].country+"</span>"),warehouse_infos+="</li>";warehouse_infos+="</ul>",warehouse_infos+="</div>",$(".warehousesExtraTabContent").length>0?$(".warehousesExtraTabContent").html(warehouse_infos):$(".product-add-to-cart").append(warehouse_infos)}}else $("#block-warehouses-stock").replaceWith("")}function displayProductSelectWarehouse(e){var t,a;allow_set_warehouse||display_selected_best_warehouse?(void 0===e&&(e=getProductData()),void 0!==e&&(0==$(".warehouses-select").length&&$(".product-variants").append('<div class="warehouses-select clearfix product-variants-item" style="height:'+(warehouse_select_height>0?warehouse_select_height+"px":"auto")+'"></div>'),t={ajax:!0,action:"getWarehouseAsCombination",id_product:$("#product_page_product_id").val(),id_product_attribute:e},void 0!==(a=$("#id_warehouse").length>0?$("#id_warehouse").val():$("#add-to-cart-or-refresh input[type=hidden][name='id_warehouse']").val())&&a>0&&(t.id_warehouse=parseInt(a)),$.ajax({url:process_cart_url,type:"POST",async:!1,dataType:"json",data:t,beforeSend:function(){$(".warehouses-select").css("opacity","0.5").html(loading_txt)},success:function(t){var a,r,s;if($(".warehouses-select").css("opacity","1").html(""),void 0!==t.hasError&&t.hasError)$(".product-variants").length>0&&$(".product-variants").append('<div class="alert alert-warning">'+t.msgError+"</div>");else if(void 0!==t.product_warehouses_select&&t.product_warehouses_select&&(warehouses_stocks_list=t.product_warehouses_select,void 0!==(a=warehouses_stocks_list[e])&&a.length>0)){if(warehouses_select="",allow_set_warehouse){for(warehouses_select+='\t<span class="control-label">'+warehouse_select_label,t.idWarehouseInCart&&t.selected_warehouse==t.idWarehouseInCart&&(warehouses_select+=' <img src="'+module_dir+'views/img/cart-remove-icon.png" title="'+remove_product_cart_txt+'" class="removeWarehouseFromCart" style="cursor:pointer">'),warehouses_select+="</span>",warehouses_select+='\t<select class="form-control form-control-select" id="id_warehouse">',r=0;r<a.length;r++)warehouses_select+='<option value="'+a[r].id_warehouse+'" ',warehouses_select+=t.idWarehouseInCart>0&&t.idWarehouseInCart!=a[r].id_warehouse?" disabled":"",warehouses_select+=t.selected_warehouse==a[r].id_warehouse?" selected":"",warehouses_select+=">",s=getWarehouseInformationsArray(a[r]),warehouses_select+=s.join(" / "),warehouses_select+="</option>";warehouses_select+="\t</select>"}if(display_selected_best_warehouse)for(r=0;r<a.length;r++)if(t.selected_warehouse==a[r].id_warehouse){warehouses_select+='<div class="alert alert-info" role="alert"><strong>'+warehouse_selected_txt+"</strong><br />",s=getWarehouseInformationsArray(a[r]),warehouses_select+=s.join("<br />"),warehouses_select+='<input type="hidden" id="id_warehouse" value="'+t.selected_warehouse+'">',warehouses_select+="</div>";break}$(".product-variants .warehouses-select").length>0&&($(".product-variants .warehouses-select").append(warehouses_select),warehouse_select_height=$(".warehouses-select").height())}}}))):$(".warehouses-select").replaceWith("")}function getWarehouseInformationsArray(e){var t=new Array;return display_warehouse_name&&e.name&&t.push(e.name),display_warehouse_location&&e.location&&t.push(e.location),display_country&&e.country&&t.push(e.country),display_warehouse_quantity&&t.push((e.available_quantity>0?parseInt(e.available_quantity):0)+" "+item_instock_txt),display_delivery_time&&e.delivery_time&&t.push(e.delivery_time),t}var warehouse_select_height,idCombination=0;$(document).ready(function(){null!=window.prestashop&&prestashop.on("updatedProduct",function(e){displayWarehousesStockInfos(e.id_product_attribute),displayProductSelectWarehouse(e.id_product_attribute),initCartButton(e.id_product_attribute)}),$("#add-to-cart-or-refresh").prepend('<input type="hidden" name="id_warehouse">'),displayWarehousesStockInfos(),displayProductSelectWarehouse(),initCartButton(),$(document).on("change","#id_warehouse",function(e){var t=$(this),a=$("#product_page_product_id").val(),r=getProductData();return void 0===r&&(r=0),$.ajax({url:process_cart_url,type:"POST",dataType:"json",async:!1,data:{ajax:!0,action:"changeWarehouseFromDropdownListInCart",id_product:a,id_product_attribute:r,id_warehouse:t.val()},success:function(a){if(void 0!==a.hasError)if(a.hasError)t.find("option").prop("selected",function(){return this.defaultSelected}),fancyCloseBox(a.msgError,"danger");else{$("#add-to-cart-or-refresh input[type=hidden][name='id_warehouse']").val(t.val());var r="#add-to-cart-or-refresh";$.post($(r).attr("action"),$(r).serialize()+"&ajax=1&action=productrefresh",null,"json").then(function(t){prestashop.emit("updateProduct",{eventType:"updatedProductCombination",event:e,reason:{productUrl:t.productUrl},refreshUrl:"",resp:t})})}}}),!1}),$(document).on("click",".removeWarehouseFromCart",function(e){$(this);var t=$("#product_page_product_id").val(),a=getProductData();return void 0===a&&(a=0),$.ajax({url:process_cart_url,type:"POST",dataType:"json",async:!1,data:{ajax:!0,action:"removeWarehouseFromCart",id_product:t,id_product_attribute:a},success:function(t){if(void 0!==t.hasError&&!t.hasError){var a="#add-to-cart-or-refresh";$.post($(a).attr("action"),$(a).serialize()+"&ajax=1&action=productrefresh",null,"json").then(function(t){prestashop.emit("updateProduct",{eventType:"updatedProductCombination",event:e,reason:{productUrl:t.productUrl},refreshUrl:"",resp:t})})}}}),!1})});